
# ============================================================
#  Big Data All-in-One — Cours Big Data
#  Un seul conteneur : NameNode + DataNode + YARN + MapReduce
#                       Hive + Tez + Sqoop + Zeppelin
# ============================================================

services:

  bigdata:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bigdata-cluster
    hostname: bigdata-node
    restart: unless-stopped

    # ── Ports ───────────────────────────────────────────────
    ports:
      - "9870:9870"    # HDFS NameNode Web UI
      - "9864:9864"    # HDFS DataNode Web UI
      - "8088:8088"    # YARN ResourceManager Web UI
      - "19888:19888"  # MapReduce Job History Server
      - "10000:10000"  # HiveServer2 (JDBC/ODBC)
      - "9083:9083"    # Hive Metastore
      - "8080:8080"    # Zeppelin Notebook UI

    # ── Variables d'environnement ────────────────────────────
    environment:
      - JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      - HADOOP_HOME=/opt/hadoop
      - HIVE_HOME=/opt/hive
      - TEZ_HOME=/opt/tez
      - SQOOP_HOME=/opt/sqoop
      - ZEPPELIN_HOME=/opt/zeppelin
      # Taille mémoire YARN (adapter selon la RAM disponible)
      - YARN_NODEMANAGER_RESOURCE_MEMORY_MB=4096
      - YARN_SCHEDULER_MAXIMUM_ALLOCATION_MB=4096
      # Mode Derby embarqué pour le Metastore Hive (pas de MySQL externe)
      - HIVE_METASTORE_DB=derby

    # ── Volumes persistants ──────────────────────────────────
    volumes:
      - namenode-data:/opt/hadoop/dfs/name      # NameNode metadata
      - datanode-data:/opt/hadoop/dfs/data      # DataNode blocs HDFS
      - hive-warehouse:/user/hive/warehouse     # Tables Hive
      - ~/hadoop-tp00/config/zeppelin/Notebooks:/opt/zeppelin/notebook
      #- zeppelin-notebooks:/opt/zeppelin/notebook # Notebooks Zeppelin
      #- ./entrypoint.sh:/entrypoint.sh
  
    # ── Ressources système ───────────────────────────────────
    # Minimum recommandé : 4 Go RAM, 2 vCPU
    mem_limit: 10g
    cpus: "4.0"

    # ── Vérification santé ───────────────────────────────────
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9870"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

# ── Volumes nommés ─────────────────────────────────────────
volumes:
  namenode-data:
    driver: local
  datanode-data:
    driver: local
  hive-warehouse:
    driver: local
  zeppelin-notebooks:
    driver: local
